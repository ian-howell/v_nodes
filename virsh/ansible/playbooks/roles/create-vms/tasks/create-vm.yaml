- set_fact:
    libvirt_domain_name: "{{ vm.node_name }}-{{ vm_instance }}"
  run_once: yes

- name: "Create qemu image extra block devices"
  shell: |
        qemu-img create \
            -f qcow2 \
            "{{ vm.image_pool }}/{{ libvirt_domain_name }}-{{ item }}".qcow2 "{{ vm.block_size }}"
  with_sequence: start=1 end="{{ vm.block_devs | int }}"

- name: "setfacl"
  shell: "setfacl -m u:libvirt-qemu:r-x {{ vm.image_pool }}"

- name: Define vm xml
  shell: |
    virt-install \
       --connect "{{ vm.uri }}" \
       --os-variant "{{ vm.os_variant }}" \
       --name "{{ libvirt_domain_name }}" \
       --memory "{{ vm.memory }}" \
       --network bridge="{{ vm.bridge_name }}" \
       --cpu host-passthrough \
       --vcpus "{{ vm.vcpus | int }}" \
       --import \
       {% for i in range(1, vm.block_devs + 1) %}
        --disk "{{ vm.image_pool }}/{{ libvirt_domain_name }}-{{ i }}.qcow2,bus=scsi,format=qcow2" \
        {% endfor %}
       --nographics \
       --noautoconsole \
       --print-xml > "/tmp/create_vm_{{ libvirt_domain_name }}.xml"

- name: Create vm
  virt:
    command: define
    xml: "/tmp/create_vm_{{ libvirt_domain_name }}.xml"
